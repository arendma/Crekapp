plotexternalcomp = function(cnames, subsys_kapp_ndat) {
  #compare kcat values from GECKO and PFBA to NIDLE
  #INPUT:
  # - char cnames:  character vector with column names of conditions in NIDLE output
  # - df subsys_kapp_ndat:  Data frame of raw NIDLE values with kappmax column (maximum over conditions)
  #                         and cleaned up subsystem info from universal irreversible model
  comp_pfba = function (kapp_ndat, cnames) {
    #compare pFBA and NIDLE results
    #INPUT:
    #INPUT:
    # - df kapp_ndat: a dataframe of kapp values as produced by NIDLE with unscaled raw kapp values
    #- char cnames:  character vector with column names of conditions in NIDLE output
    require(VennDiagram)
    kapp_pdat=read.delim('Results/pFBA//kcat_p.tsv', na.strings = 'NaN')
    if (!all(cnames %in% colnames(kapp_pdat))) {
      stop("Not all cnames are contained as column names in kcat_p.tsv")
    }
    
    
    kapp_pdat$kappmax=apply(kapp_pdat[, colnames(kapp_pdat) %in% cnames],1,max, na.rm=TRUE)
    
    np_comptab=merge(kapp_ndat[,c("Reaction", "JGIgeneID", "UniprotgeneID", "ECNumber", "kappmax")], kapp_pdat[,c("Rxns", "kappmax")], by.x="Reaction", by.y="Rxns", all = TRUE)
    colnames(np_comptab)[colnames(np_comptab) %in% "kappmax.x"]="NIDLE"
    colnames(np_comptab)[colnames(np_comptab) %in% "kappmax.y"]="pFBA"
    pvnrho=cor(x=log10(np_comptab[!(is.na(np_comptab$NIDLE))&!(is.na(np_comptab$pFBA)),'NIDLE']), y=log10(np_comptab[!(is.na(np_comptab$NIDLE))&!(is.na(np_comptab$pFBA)),'pFBA']), method = "spearman")
    gvnrhotest=cor.test(x=log10(np_comptab[!(is.na(np_comptab$NIDLE))&!(is.na(np_comptab$pFBA)),'NIDLE']), y=log10(np_comptab[!(is.na(np_comptab$NIDLE))&!(is.na(np_comptab$pFBA)),'pFBA']), method = "spearman")
    print(paste("Pvalue for the spearman correlation of NIDLE and pFBA:", signif(gvnrhotest$p.value, 2)))
    pvn=ggplot(np_comptab[!(is.na(np_comptab$NIDLE))&!(is.na(np_comptab$pFBA)),], aes(x=NIDLE, y=pFBA)) + geom_point(size=4, alpha=0.7) +
      scale_x_log10() + scale_y_log10() + ylab('maximum kapp pFBA') + xlab('maximum kapp NIDLE') +
      annotate(geom='text', x=min(np_comptab[!(is.na(np_comptab$NIDLE))&!(is.na(np_comptab$pFBA)),"NIDLE"])+3, y=max(np_comptab[!(is.na(np_comptab$NIDLE))&!(is.na(np_comptab$pFBA)),"pFBA"])-1, size=8,  label=paste('\u03c1 = ', round(pvnrho, 2))) +
      geom_abline(intercept = 0, slope = 1) + theme_bw() + theme(text=element_text(size=25))
    ggsave("Results/NIDLE/kcat_pFBAvn.pdf",pvn, width=7, height=7, device=grDevices::cairo_pdf)
    write.table(np_comptab[!(is.na(np_comptab$NIDLE))&!(is.na(np_comptab$pFBA)),], "Results/NIDLE/kcat_pFBAvn.tsv", row.names = FALSE, sep="\t")
    #plot venn diagram
    venn.diagram(list(NIDLE=kapp_ndat$Reaction, pFBA=kapp_pdat$Reaction), filename="Results/NIDLE/kcat_pFBAvn_venn.png", imagetype = "png")
  }
  comp_pfba(subsys_kapp_ndat, cnames)
  
  comp_GKO = function (subsys_kapp_ndat, cnames) {
    #INPUT:
    # - df subsys_kapp_ndat: a dataframe of raw kapp values as produced with subsystem info as generated by plot_nidle_kapp.r
    #- char cnames:  character vector with column names of conditions in NIDLE output
    
    #Import GECKO kcats - these is one value for each reaction in the irreversible model which is linked to a GPR rule
    GECKOkcat=read.csv('Program/deps/GECKOcre/models/geCre1355Autotrophic_Rep1/geCre1355Autotrophic_Rep1_kcats.tab')
    
    #match reaction specific kcats
    
    nidle_cols=c( cnames, 'kappmax', 'sparseSubSystem', 'Macrosystem')
    comp_mat=as.data.frame(matrix(nrow=nrow(GECKOkcat), ncol=length(nidle_cols)+2))
    colnames(comp_mat)=c('GECKO', 'GKO_Match' , nidle_cols)
    for (i in 1:nrow(comp_mat)) {
      #take maximum kcat for GECKO 
      if (nchar(GECKOkcat$kcats[i])>0) {#
        max_idx=which.max(as.numeric(unlist(strsplit(GECKOkcat$kcats[i], ';'))))
        if (length(unlist(strsplit(GECKOkcat$kcats[i], ';')))==length(unlist(strsplit(GECKOkcat$MScores[i], ';')))){
          comp_mat[i,1]=as.numeric(unlist(strsplit(GECKOkcat$kcats[i], ';')))[max_idx]
          comp_mat[i,2]=as.numeric(unlist(strsplit(GECKOkcat$MScores[i], ';')))[max_idx]
        }
      }
      rexn=GECKOkcat$rxns[i]
      #check if reversible reaction
      if (grepl('_REV', rexn)) {
        rexn=gsub('_REV', '', rexn)
        nkcat=subsys_kapp_ndat[subsys_kapp_ndat$Reaction %in% paste(rexn, '_b', sep=""), nidle_cols]
      } else {
        if (rexn %in% subsys_kapp_ndat$Reaction) {
          nkcat=subsys_kapp_ndat[subsys_kapp_ndat$Reaction %in% rexn, nidle_cols]
        } else {
          nkcat=subsys_kapp_ndat[subsys_kapp_ndat$Reaction %in% paste(rexn, '_f', sep="", collapse = ""), nidle_cols]
        }
      }
      if (nrow(nkcat)>1) {
        stop("one to many mapping in reactionkcat table detected")
      }
      if (nrow(nkcat)>0) {comp_mat[i,3:ncol(comp_mat)]=nkcat}
    }
    
    print(paste(sum(!(is.na(comp_mat$kappmax[!(is.na(comp_mat$GECKO))])))/sum(!is.na(comp_mat$GECKO)), 
                'of reactions with ec number annotation have a kapp_max assigned'))
    sc_plot = function(comp_mat, cnames, resdir) {
      #Plot scatter plots of GECKO assigned kcats and NIDLE calculate kapp
      #overall and per GECKO match criteria
      #INPUT:
      #- df comp_mat: comparison matrix between GECKO and NIDLE raw max cat values
      #- char cnames:  character vector with column names of conditions in NIDLE output
      #- char resdir: character giving the directory in which scatter plots are to be saved
      if (!(dir.exists(resdir))) {
        dir.create(resdir)
      }
      nicelabs=c('Organism + substrate', 'Substrate', 'Organism', 'Any', 'SA organism', 'SA any')
      gvnrho=cor(x=log10(comp_mat[!(is.na(comp_mat$GECKO))&!(is.na(comp_mat$kappmax)),'GECKO']), y=log10(comp_mat[!(is.na(comp_mat$GECKO))&!(is.na(comp_mat$kappmax)),'kappmax']), method = "spearman")
      gvnrhotest=cor.test(x=log10(comp_mat[!(is.na(comp_mat$GECKO))&!(is.na(comp_mat$kappmax)),'GECKO']), y=log10(comp_mat[!(is.na(comp_mat$GECKO))&!(is.na(comp_mat$kappmax)),'kappmax']), method = "spearman")
      print(paste("Pvalue for the spearman correlation of NIDLE and GECKO:", signif(gvnrhotest$p.value, 2)))
      gvn=ggplot(comp_mat[!(is.na(comp_mat$GECKO))&!(is.na(comp_mat$kappmax)),], aes(x=GECKO, y=kappmax, color=as.factor(GKO_Match))) + geom_point(size=4, alpha=0.7) +
        scale_color_manual(name="Match Quality", values=cbPalette[1:length(unique(comp_mat$GKO_Match))], labels=nicelabs) + 
        scale_x_log10() + scale_y_log10() + ylab('maximum kapp NIDLE') + xlab('kcat GECKO') +
        annotate(geom='text', x=min(comp_mat$GECKO[!(is.na(comp_mat$GECKO))&!(is.na(comp_mat$kappmax))])+3, y=max(comp_mat$kappmax[!(is.na(comp_mat$GECKO))&!(is.na(comp_mat$kappmax))])-1, size=8,  label=paste('\u03c1 = ', round(gvnrho, 2))) +
        geom_abline(intercept = 0, slope = 1) + theme_bw() + theme(text=element_text(size=25))
      ggsave(file.path(resdir, "kcat_gvn_all.pdf"),gvn, width=10, height=7, device=grDevices::cairo_pdf)
      outtab=comp_mat[!(is.na(comp_mat$GECKO))&!(is.na(comp_mat$kappmax)), c('GECKO', 'kappmax', 'GKO_Match')]
      outtab$GKO_Match=nicelabs[outtab$GKO_Match]
      write.table(outtab, file.path(resdir, "kcat_gvn_all.tsv"), sep="\t", row.names=FALSE)
      orgkcatrho= cor.test(x=log10(comp_mat[!(is.na(comp_mat$GECKO))&!(is.na(comp_mat$kappmax))&comp_mat$GKO_Match %in% c(1,3), 'GECKO']),
                           y=log10(comp_mat[!(is.na(comp_mat$GECKO))&!(is.na(comp_mat$kappmax))&comp_mat$GKO_Match %in% c(1,3), 'kappmax']), method="spearman")
      print(paste('spearman rho for all organism specific kcats:', round(orgkcatrho$estimate,2)))
      print(paste("p-value:", signif(orgkcatrho$p.value, 2)))
      
      #Plot a boxplot of the log10 fold differences of all and only organism specficic kcats
      rat_mat_all=comp_mat[!(is.na(comp_mat$GECKO))&!(is.na(comp_mat$kappmax)),]
      rat_mat_all$Ratio=log10(rat_mat_all$kappmax/rat_mat_all$GECKO)
      rat_mat_all$x=rep("All", nrow(rat_mat_all))
      print(paste("The median log10 fold difference between NIDLE kapps and GECKO kcats over all reactions is", median(rat_mat_all$Ratio)))
      rat_mat_spec=rat_mat_all[rat_mat_all$GKO_Match %in% c(1,3),]
      rat_mat_spec$x="Org specific"
      print(paste("The median log10 fold difference between NIDLE kapps and organism specific matched GECKO kcats is", median(rat_mat_spec$Ratio)))
      plot_mat= rbind(rat_mat_all, rat_mat_spec)
      datrange=range(plot_mat$Ratio)
      rp= ggplot(data=plot_mat, aes(x=x, y=Ratio)) +  geom_boxplot(alpha=0.3, outlier.shape = NA) + 
        geom_dotplot(binaxis = "y", binwidth=(datrange[2]-datrange[1])/90, stackdir ="center", dotsize = 1, stackratio = 0.8, color=NA) + 
        theme_light() + ylab(expression(log[10]~maxkapp[NIDLE]/kcat[GECKO])) + scale_fill_discrete(labels=nicelabs) +
        theme(text = element_text(size=25), axis.title.x = element_blank()) 
      ggsave(file.path(resdir, "kcat_gvn_all_ratbox.pdf"),rp, device=grDevices::cairo_pdf)
      write.table(plot_mat[,c('Ratio', 'x')], file.path(resdir, "kcat_gvn_all_ratbox.tsv"), sep="\t", row.names=FALSE)
      
      
      mat_labels=c('org+subs', 'subs', 'org', 'any', 'SA org', 'SA_any')
      helpf_plot=function(m) {
        ##Plot scatterplots based on match conservativeness
        plot_mat=comp_mat[!(is.na(comp_mat$GECKO))&!(is.na(comp_mat$kappmax))&comp_mat$GKO_Match %in% m ,c('GECKO', 'GKO_Match','kappmax')]
        if (nrow(plot_mat>2)){
          rho=cor(x=log10(plot_mat$GECKO), y=log10(plot_mat$kappmax), method="spearman")
          p1=ggplot(plot_mat, aes(x=GECKO, y=kappmax)) + geom_point(size=3) + labs(title = mat_labels[m]) +
            scale_x_log10() + scale_y_log10() + ylab('maximum kapp NIDLE') + xlab('kcat GECKO') +
            annotate(geom='text', x=min(plot_mat[,1:2])+(max(plot_mat[,1:2])-min(plot_mat[,1:2]))/3, y=max(plot_mat[,1:2])-1, size=8,  label=paste('\u03c1 = ', round(rho, 2))) +
            geom_abline(intercept = 0, slope = 1) + theme_bw() + theme(text=element_text(size=25))
          ggsave(file.path(resdir, paste('kcat_gvs_', paste(mat_labels[m], sep=''), '.pdf', sep='', collapse ='')), p1, device=grDevices::cairo_pdf, width=8, height=8)
          outtab=plot_mat
          outtab$GKO_Match=mat_labels[outtab$GKO_Match]
          write.table(outtab, file.path(resdir, paste('kcat_gvs_', paste(mat_labels[m], sep=''), '.tsv',sep="", collapse ='')), sep="\t", row.names=FALSE)
          
          
          #Plot boxplots for the ratio of kapp NIDLE/ kcat GECKO
          plot_mat2=plot_mat
          plot_mat2$Ratio=log10(plot_mat2$kappmax/plot_mat2$GECKO)
          plot_mat2$x=rep(1, nrow(plot_mat2))
          plot_mat2=plot_mat2[, c('x', 'Ratio', 'GKO_Match')]
          datrange=range(plot_mat2$Ratio)
          p2= ggplot(data=plot_mat2, aes(x=x, y=Ratio)) +  geom_boxplot(alpha=0.3, outlier.shape = NA) + 
            geom_dotplot(binaxis = "y", binwidth=(datrange[2]-datrange[1])/90, stackdir ="center", dotsize = 1, stackratio = 0.8, color=NA) + 
            theme_light() + ylab(expression(log[10]~maxkapp[NIDLE]/kcat[GECKO])) +
            theme(text = element_text(size=25), axis.title.x = element_blank(), axis.text.x=element_blank()) 
          ggsave(file.path(resdir, paste('kcat_gvs_ratbox_', paste(mat_labels[m], sep=''), '.pdf', sep='', collapse ='')), p2, device=grDevices::cairo_pdf)
          #save sourcedata file
          write.table(plot_mat2[, c('Ratio', 'GKO_Match')], file.path(resdir, paste('kcat_gvs_ratbox_', paste(mat_labels[m], sep=''), '.tsv',sep="",collapse ='')), sep="\t", row.names=FALSE)
        }
      }
      lapply(sort(unique(comp_mat$GKO_Match[!(is.na(comp_mat$GKO_Match))])), helpf_plot)
      #plot a scatterplot of all organism specific assigned kcats
      helpf_plot(c(1,3))
    }
    sc_plot(comp_mat, cnames, "Results/eccomp/gvn_scat")
    vio_plot = function(comp_mat, cnames, resdir){
      #Plot violin plots of the distribution of kapp/kcat for kapp max, and the conditions
      if (!(dir.exists(resdir))) {
        dir.create(resdir)
      }
      # revocer color mapping for macrosystems ordered by number of kapps
      fillvalues=cbPalette[1:length(unique(comp_mat$Macrosystem[!is.na(comp_mat$Macrosystem)]))]
      temptab=table(comp_mat$Macrosystem)
      names(fillvalues)=names(temptab)[order(temptab)]
      
      #calculate the ration of kappp divided by kcat for the sparse set
      #set 0 values to NA to exclude them from plotting
      rat_comp_mat=comp_mat
      rat_comp_mat[!(is.na(rat_comp_mat)) & rat_comp_mat==0]=NA
      rat_comp_mat=rat_comp_mat[!is.na(comp_mat$GECKO) & apply(!is.na(comp_mat[,cnames]), 1, sum)!=0,]
      rat_comp_mat[,c(cnames, 'kappmax')]=rat_comp_mat[,c(cnames, 'kappmax')]/rat_comp_mat$GECKO
      #if zeros are included add pseudocount
      if (any(rat_comp_mat[,cnames]==0, na.rm=TRUE)) {
        error("0 values in comp_mat detected this is an  internal error :(")
      }
      
      mkplot_cond= function(rat_comp_mat, cnames, fp) {
        #Function to plot the boxplot of kapp/kcat with dots for observations subsetted by condition
        #INPUT:
        #  - rat_comp_mat: the matrix of raw ratios between calculated kapp values and kcat values having cnames as column names
        #- char cnames:  character vector with column names of conditions in NIDLE output
        # - char fp:  charcter vector containing the file path to which a pdf of the violin plot is to be saved
        
        source("Program/deps/utilities/expandcolv3.r", local =TRUE)
        #transform to long format
        plotdat=expandcol(rat_comp_mat[,c(cnames, "sparseSubSystem",  "Macrosystem")], 1:length(cnames))
        #remove any NA values
        plotdat=plotdat[!is.na(plotdat$x1),]
        colnames(plotdat)[colnames(plotdat) %in% "x1"]="Ratio"
        colnames(plotdat)[colnames(plotdat) %in% "x2"]="Condition"
        plotdat$Ratio=log10(plotdat$Ratio)
        #function to produce the violin plot
        datrange=range(plotdat$Ratio)
        p= ggplot(data=plotdat, aes(x=Condition, y=Ratio)) +  geom_boxplot(alpha=0.3, outlier.shape = NA) + 
          geom_dotplot(binaxis = "y", binwidth=(datrange[2]-datrange[1])/90, stackdir ="center", dotsize = 1, stackratio = 0.8, color=NA) + 
          theme_light() + ylim(datrange[1]-0.1*(datrange[2]-datrange[1]), datrange[2]+0.2*(datrange[2]-datrange[1])) +
          ylab(expression(log[10]~maxkapp[NIDLE]/kcat[GECKO])) + scale_x_discrete(labels=clabs) +
          theme(text = element_text(size=35), axis.title.x = element_blank(), axis.text.x=element_text(angle=60, hjust=1)) 
        ggsave(fp, p, width = length(unique(plotdat$Condition))*1.5, height = 8)
        #save sourcedata file
        write.table(plotdat[, c("Ratio", "Condition")], file = gsub("pdf$", "tsv", fp), row.names=FALSE, sep="\t")
        #Do tukeys test because of large and queal nubmer of observations and low skewedness
        print(paste("Result of Tukey test for significant differences between kapp/kcat ratios in", basename(fp)))
        mod=aov(Ratio~Condition, data=plotdat)
        print(aov)
        print(TukeyHSD(mod))
      }
      # plot for different sets
      mkplot_cond(rat_comp_mat, cnames, file.path(resdir, "kappkcatratios_diffset.pdf"))
      # plot for samesets
      mkplot_cond(rat_comp_mat[!apply(is.na(rat_comp_mat[,cnames]), 1, any),], cnames, file.path(resdir,  "kappkcatratios_sameset.pdf"))
      
      
      mkplot_macsys= function(rat_comp_mat, cnames, fp, fillvalues) {
        #Function to plot the violin plot of max(kapp)/kcat with dots for observations subsdetted by macrosystem
        #INPUT:
        #  - rat_comp_mat: the matrix of raw ratios between calculated kapp values and kcat values having cnames as column names
        #- char cnames:  character vector with column names of conditions in NIDLE output
        # - char fp:  charcter vector containing the file path to which a pdf of the violin plot is to be saved
        # - char fillvalues: a named character vector containing the color codes used for aech macrosystem with names having macrosystem values
        
        #source("Program/deps/utilities/expandcolv3.r", local =TRUE)
        #filter for kappmax
        plotdat=rat_comp_mat[, c("sparseSubSystem", "Macrosystem", "kappmax")]
        #check for any NA values
        if (any(is.na(plotdat$kappmax))) {
          stop("Encounter NA values in kappmax column of comp_mat. Check the indexing of comp_mat")
        }
        plotdat$kappmax=log10(plotdat$kappmax)
        #function to produce the violin plot
        datrange=range(plotdat$kappmax)
        p= ggplot(data=plotdat, aes(x=Macrosystem, y=kappmax, fill=Macrosystem)) + geom_boxplot(alpha=0.3, outlier.shape = NA) + 
          geom_dotplot(binaxis = "y", binwidth=(datrange[2]-datrange[1])/90, stackdir ="center", dotsize = 1, stackratio = 0.8, color=NA) + 
          theme_light() + ylab(expression(log[10]~maxkapp[NIDLE]/kcat[GECKO])) + scale_fill_manual(values=fillvalues) +
          theme(legend.position = "none", text = element_text(size=25), axis.title.x = element_blank(), axis.text.x=element_text(angle=60, hjust=1)) 
        ggsave(fp, p, width = length(unique(plotdat$Macrosystem))*1.5, height = 8)
        #save sourcedata file
        write.table(plotdat, file = gsub("pdf$", "tsv", fp), row.names=FALSE, sep="\t")
        print("Result of Kruskal Wallace test for significant differences between kapp/kcat ratios in Macrosystems:")
        print(kruskal.test(kappmax~Macrosystem, data = plotdat))
      }
      mkplot_macsys(rat_comp_mat, cnames, file.path(resdir, "kappcatratiospermacsys.pdf"), fillvalues)
    }
    vio_plot(comp_mat, cnames, "Results/eccomp")
  }
  comp_GKO(subsys_kapp_ndat, cnames)
}